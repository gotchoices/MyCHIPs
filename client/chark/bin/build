#!/bin/bash
#Build android and/or IOS release images
#Copyright MyCHIPs.org; See license in root of this package
# -----------------------------------------------------------------------------
target=all
path_a="android/app/build/outputs/apk/release/app-release.apk"
path_i="ios/build/chark.xcarchive"
built_a=false
built_i=false
orgdir=$(pwd)
mydir="$(dirname $BASH_SOURCE)"		#Where this script is

build_ios() {
  cd $mydir/../ios
  echo "Installing pods for iOS build..."
  if pod install; then
    echo "Building iOS app..."
    if xcodebuild -workspace chark.xcworkspace -scheme chark -configuration Release -sdk iphoneos; then
      built_i=true
      # Archive the build
      archive_path="./build/chark.xcarchive"
      xcodebuild -workspace chark.xcworkspace -scheme chark -configuration Release -sdk iphoneos -archivePath "${archive_path}" archive
    else
      built_i=false
    fi
  else
    built_i=false
  fi
  cd $orgdir
}

path_ios() {
  if $built_i; then
    echo "Path to iOS archive: ios/build/chark.xcarchive"
  fi
}

deploy_ios() {
  if $built_i && [ ! -z "$MYCHIPS_IOS_DEPLOY" ]; then
    echo "Deploying iOS build to $MYCHIPS_IOS_DEPLOY"
    # Add your deployment logic here - this could be copying the archive to a server
    # or exporting an IPA file and copying it somewhere
  fi
}

build_android() {
  cd $mydir/../android 
  if ./gradlew assembleRelease; then
    built_a=true
  else
    built_a=false
  fi
  cd $orgdir			#;echo "RES:$build_a"
}

path_android() {
  if $built_a; then
    echo "Path to APK:${path_a}"
  fi
}

deploy_android() {
  if $built_a && [ ! -z "$MYCHIPS_ANDROID_APK_DEPLOY" ]; then
    echo "Deploying Android APK:${path_a} to $MYCHIPS_ANDROID_APK_DEPLOY"
    scp ${mydir}/../${path_a} $MYCHIPS_ANDROID_APK_DEPLOY
  fi
}

if [ -z "$APP_STORE_FILE" ]; then
  read -p "Enter keystore filename: " APP_STORE_FILE
  export APP_STORE_FILE
fi

if [ -z "$APP_STORE_PASSWORD" ]; then
  read -sp "Enter keystore password: " APP_STORE_PASSWORD
  echo
  export APP_STORE_PASSWORD
fi

if [ -z "$APP_KEY_PASSWORD" ]; then
  read -sp "Enter individual key password (enter if same): " APP_KEY_PASSWORD
  echo
  if [ -z "$APP_KEY_PASSWORD" ]; then
    APP_KEY_PASSWORD="$APP_STORE_PASSWORD"
  fi
  export APP_KEY_PASSWORD
fi

if [ "$1" = "all" ]; then
  build_android;	build_ios
  path_android;		path_ios
  deploy_android;	deploy_ios

elif [ "$1" = "ios" ]; then
  build_ios;		path_ios;	deploy_ios

else
  build_android;	path_android;	deploy_android
fi
